"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.generateWarning = generateWarning;
exports.scrapeIds = scrapeIds;
exports.recordContentUsage = recordContentUsage;

function generateWarning(stats, source, message) {
  if (stats) {
    if (!Array.isArray(stats.warnings)) {
      stats.warnings = [];
    }

    stats.warnings.push({
      source,
      message
    });
  }
}

function scrapeIds(obj, depth = 1, result = []) {
  if (Array.isArray(obj)) {
    obj.forEach(item => scrapeIds(item, depth, result));
  } else if (obj && typeof obj === 'object') {
    const newDepth = depth + 1;
    Object.keys(obj).forEach(key => {
      const value = obj[key];

      if (key === '_id' && typeof value === 'string') {
        result.push([value, depth]);
      } else {
        scrapeIds(value, newDepth, result);
      }
    });
  }

  return result;
}

function recordContentUsage(stats, data, path) {
  if (stats.contentUsage) {
    const ids = scrapeIds(data);
    ids.forEach(([id, depth]) => {
      if (!stats.contentUsage[id]) {
        stats.contentUsage[id] = {};
      }

      const prevDepth = stats.contentUsage[id][path];
      stats.contentUsage[id][path] = prevDepth ? Math.min(depth, prevDepth) : depth;
    });
  }
}